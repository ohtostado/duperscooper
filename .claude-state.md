# Claude State - duperscooper GUI Development

## Recent Work Summary

### Fixed: Best album displayed in wrong order (Issue #2)
**Problem**: In the GUI, the best quality album was appearing below lower quality albums in duplicate groups, even though it was correctly marked with a star.

**Root Cause**: The realtime scanner (`realtime_scanner.py`) was not sorting albums by quality before sending them to the GUI. The CLI backend sorts albums correctly, but the GUI's realtime scanner was iterating through albums in their original order from the duplicate finder.

**Fix Applied**:
- File: `src/duperscooper_gui/utils/realtime_scanner.py`
- Added sorting by quality score (highest first) before building group data
- Line 199-202: Sort albums by `avg_quality_score` in descending order
- Now matches CLI behavior: best album always appears first in the list

**Testing**: Run GUI on test-albums-synthetic, verify Album D shows 320kbps first (with star), then 256kbps second.

### Investigated: Albums showing 100% similarity (Issue #1)
**Problem**: All test albums show 100.0% similarity even after audio transformations (pitch shift, time stretch).

**Root Cause**: Synthetic audio (sine waves with harmonics) produces identical Chromaprint fingerprints even after transformations. The test audio is too simple - all variants have fingerprint: `558758263,558758263,558758263...`

**Why This Happens**:
1. Simple waveforms create repetitive fingerprints
2. Chromaprint is designed to be robust against minor pitch/tempo changes
3. Small pitch shifts (<1 semitone) don't change the basic spectral pattern enough

**Solution**: Use **real music files** instead of synthetic audio
- Created guide: `TESTING-VARYING-SIMILARITY.md`
- Explains how to download public domain music
- Provides exact ffmpeg commands for creating 97-100% similarity range
- Real music has complex harmonics that respond predictably to transformations

**Current Status**: Test albums work for 100% similarity testing, but cannot demonstrate varying percentages without real audio.

### Added: Allow Partial Albums Checkbox
**Implementation**:
- Added checkbox in GUI: "Allow partial album matches"
- Located in new row below mode dropdown
- Disabled by default, only enabled in album mode
- Checked by default when enabled
- Connected to `on_allow_partial_changed()` handler
- Will be used when scan is started (not yet implemented in scanner params)

**Files Modified**:
- `src/duperscooper_gui/ui/dual_pane_widget.ui` - UI layout
- `src/duperscooper_gui/windows/dual_pane_viewer.py` - Handler and visibility logic

**Next Steps**: Wire checkbox state to scanner parameters when starting scan.

### Test Album Generation Scripts

**Created**: `scripts/create-varying-similarity-albums.sh`
- Generates Album D with 4 variants
- Uses pitch shifting and time stretching
- **Issue**: All produce identical fingerprints due to simple synthetic audio
- **Recommendation**: Replace with real music for testing

**Existing**: `scripts/generate-test-audio.sh`
- Generates Albums A, B, C with various scenarios
- Works correctly for 100% similarity testing
- Tests different metadata scenarios (MusicBrainz ID, ID3 only, untagged)
- Tests partial album matching (requires `--allow-partial-albums`)

## Current Architecture

### GUI Flow
1. User adds paths and selects mode
2. Clicks "Start Scan"
3. `main_window.py` creates `RealtimeScanThread`
4. Scanner emits `group_found` signal for each duplicate group
5. `dual_pane_viewer.py` receives signal and calls `add_duplicate_group()`
6. Items displayed in results tree with checkboxes

### Data Flow
- Backend (CLI) → JSON with sorted albums (best first)
- GUI Scanner → Now also sorts albums (best first) ✅ FIXED
- Display → Shows items in order received from scanner

## Outstanding Items

### High Priority
1. **Wire "Allow Partial Albums" checkbox to scanner**
   - Pass checkbox state to `RealtimeScanThread`
   - Update `AlbumDuplicateFinder` initialization with `allow_partial` parameter
   - Test with Album B Extended Edition

2. **Create real music test albums**
   - Download 3-5 public domain songs
   - Generate variants with pitch/tempo changes
   - Verify actual similarity percentages (97-100%)
   - Update test documentation

### Medium Priority
3. **Similarity column visualization**
   - User mentioned "later we will add a small bar chart there"
   - Currently just shows percentage text
   - Could add QProgressBar or custom painted bar

4. **MyPy type errors in realtime_scanner.py**
   - Pre-existing errors about unpacking strings, object attributes
   - Not blocking functionality
   - Should be fixed for clean type checking

### Low Priority
5. **Remove debug logging from realtime_scanner.py**
   - Lines 128-167 contain DEBUG progress messages
   - Were added for troubleshooting, can be removed or made conditional

## Key Files Reference

**GUI Core**:
- `src/duperscooper_gui/windows/dual_pane_viewer.py` - Main results/staging UI
- `src/duperscooper_gui/windows/main_window.py` - Main window, coordinates scanner
- `src/duperscooper_gui/utils/realtime_scanner.py` - Background scanning thread
- `src/duperscooper_gui/ui/dual_pane_widget.ui` - Qt Designer UI file

**Backend**:
- `src/duperscooper/__main__.py` - CLI entry, output formatting
- `src/duperscooper/finder.py` - Track duplicate detection, quality identification
- `src/duperscooper/album.py` - Album scanning and duplicate detection
- `src/duperscooper/hasher.py` - Audio fingerprinting, quality scoring

**Testing**:
- `test-albums-synthetic/` - Generated test albums
- `scripts/generate-test-audio.sh` - Main test generation
- `scripts/create-varying-similarity-albums.sh` - Attempt at varying similarity (doesn't work with synthetic audio)
- `TESTING-VARYING-SIMILARITY.md` - Guide for creating real test albums

## Session Notes

- User testing on `./test-albums-synthetic` in album mode
- Confirmed Group 3 (Album D) was showing 256kbps first, 320kbps second (now fixed)
- All test albums showing 100% similarity (expected due to synthetic audio limitations)
- GUI checkbox for partial albums added but not yet wired to scanner
