# Claude Development State - duperscooper

**Last Updated:** 2025-10-05
**Current Branch:** main
**Latest Commit:** 44ebfaf (feat: make album mode default and add GUI settings system)

## Project Overview

**duperscooper** is a Python CLI and GUI application that finds duplicate audio files using fuzzy perceptual matching (Chromaprint fingerprints with Hamming distance) across different formats, bitrates, and encodings. Includes full album-level duplicate detection with multiple matching strategies and a PySide6/Qt GUI.

## Current Status

### ✅ Album Mode: COMPLETE (Default)

Album mode is now the default for both CLI and GUI:
- `--album-mode` is default (use `--track-mode` to disable)
- GUI defaults to Album Mode dropdown selection
- Track-level metadata display in album mode
- Multiple matching strategies (auto, musicbrainz, fingerprint)
- Comprehensive quality scoring and comparison

### ✅ GUI: Enhanced Results Viewer COMPLETE (PR #16 - Merged)

Latest session completed comprehensive results viewer enhancements and settings system:
- Visual improvements with color-coded similarities
- Album/Artist columns added (8 columns total)
- Platform-specific TOML configuration system
- Auto-generated user config on first run
- Customizable colors and preferences
- Track-level metadata extraction

### 🎯 Current: GUI Development Continues

Next priorities:
- Backend deletion integration (staging management)
- Staging tab implementation
- Settings/preferences dialog

## Recent Development Session Summary

### Latest Session: Enhanced Results Viewer & Settings System (Oct 5, 2025) ✅

**PR #16 Merged:** Enhanced results viewer, album mode default, and GUI settings system

**Implemented:**

1. **Album Mode as Default**
   - CLI: `--album-mode` default=True, added `--track-mode` flag
   - GUI: Album mode selected by default in dropdown
   - Backend interface updated to use `--track-mode` when disabled

2. **Track-Level Metadata in Album Mode**
   - Display individual track metadata (not aggregated album metadata)
   - Added `AudioHasher.get_audio_tags()` for ffprobe extraction
   - Shows album/artist from actual file tags
   - Helps identify matches with differing metadata

3. **GUI Settings System**
   - Created `src/duperscooper_gui/config/` module
   - Platform-specific config paths:
     - Linux/macOS: `~/.config/duperscooper/duperscooper-gui-options.toml`
     - Windows: `%APPDATA%\duperscooper\duperscooper-gui-options.toml`
   - Auto-generated from template on first run
   - Template stored in `templates/default_config.toml`
   - Human-editable TOML format

4. **Configuration Sections**
   - `[colors]`: Group headers, best quality, similarity indicators
   - `[scan]`: Default mode, algorithm, threshold, workers
   - `[ui]`: Window size, auto-expand groups

5. **Results Viewer Enhancements** (Items 1-4 from GUI Plans)
   - Fixed unreadable group headers (dark text on light background)
   - Added Album and Artist columns (8 columns total)
   - Removed " (avg)" from quality data, added to column header
   - Color-coded similarity percentages
   - Icons for files/albums
   - Comprehensive tooltips
   - Action button color coding

6. **Bug Fixes**
   - Handle CLI exit code 2 (duplicates found) as success
   - Multi-line JSON extraction in backend
   - Field name mismatch: `total_size` vs `total_size_bytes`
   - Replaced error popups with inline scan log messages
   - Type annotations for optional metadata fields

**Files Created:**
- `src/duperscooper_gui/config/__init__.py`
- `src/duperscooper_gui/config/settings.py`
- `src/duperscooper_gui/config/templates/default_config.toml`

**Files Modified:**
- `src/duperscooper/__main__.py` - Album mode default, track metadata
- `src/duperscooper/finder.py` - Type annotations
- `src/duperscooper/hasher.py` - Added `get_audio_tags()`
- `src/duperscooper_gui/models/results_model.py` - Album/artist fields
- `src/duperscooper_gui/utils/backend_interface.py` - Exit codes, track mode
- `src/duperscooper_gui/windows/main_window.py` - Default album mode
- `src/duperscooper_gui/windows/results_viewer.py` - 8 columns, colors
- `src/duperscooper_gui/ui/results_widget.ui` - Updated styling

**Commits:**
- 44ebfaf - feat: make album mode default and add GUI settings system
- 41d1b4a - feat: implement CLAUDE-GUI-PLANS items 1-4
- 8a3a02c - fix: handle CLI exit code 2 (duplicates found) as success
- a618f1b - feat: replace error popups with inline scan log messages
- 6df3e48 - fix: resolve GUI scan issues for track and album modes
- f697e7b - feat: enhance results viewer with visual improvements

### Previous Session: GUI Foundation & Results Viewer (Oct 4, 2025) ✅

**PR #12 Merged:** GUI Foundation
**PR #13 Merged:** Results Viewer Implementation

See "GUI Development" section below for complete details.

### Previous Session: Staging Folder Deletion & Docker (Oct 4, 2025) ✅

**PR #9 Merged:** Feature 1 Complete - Staging Folder Deletion System

See "Pre-GUI Feature Implementation" section below for complete details.

## Current Project State

### Technology Stack

- **Language:** Python 3.8+ (tested on 3.13)
- **Audio Fingerprinting:** Direct `fpcalc` binary calls (Python 3.13 compatible)
- **Metadata Extraction:** `ffprobe` binary
- **GUI Framework:** PySide6 >= 6.6.0
- **Dependencies:**
  - `tqdm>=4.66.0` - Progress bars
  - `colorama>=0.4.6` - Cross-platform terminal colors
- **Dev Dependencies:**
  - `black==24.8.0` - Code formatting
  - `ruff==0.6.3` - Linting
  - `mypy==1.11.2` - Type checking
  - `pytest==8.3.2` - Testing
  - `pytest-cov==5.0.0` - Coverage

### Code Structure

```text
src/duperscooper/
├── __init__.py       # Package metadata, version
├── __main__.py       # CLI interface, output formatting, colorama integration
├── cache.py          # CacheBackend interface, SQLite/JSON implementations
├── hasher.py         # AudioHasher: perceptual & exact hashing, metadata, tags
├── finder.py         # DuplicateFinder: search logic, parallelization
│                     # DuplicateManager: file operations
│                     # AlbumManager: album deletion operations
├── album.py          # Album: dataclass for album metadata
│                     # AlbumScanner: album discovery and metadata extraction
│                     # AlbumDuplicateFinder: album duplicate detection
├── staging.py        # StagingManager: deletion staging and restoration
├── rules.py          # RuleEngine: deletion rules and strategies
└── apply.py          # ScanResultLoader, ApplyEngine: JSON/CSV ingestion

src/duperscooper_gui/
├── __init__.py
├── __main__.py       # GUI entry point
├── config/           # Configuration system
│   ├── __init__.py
│   ├── settings.py   # Settings loader with platform-specific paths
│   └── templates/
│       └── default_config.toml  # User config template
├── ui/               # Qt Designer .ui files
│   ├── main_window.ui
│   └── results_widget.ui
├── windows/          # Python UI loaders
│   ├── __init__.py
│   ├── main_window.py
│   └── results_viewer.py
├── models/           # Data models
│   ├── __init__.py
│   └── results_model.py
└── utils/            # Helper functions
    ├── __init__.py
    └── backend_interface.py
```

### Key Algorithms

#### Album Matching (Album Mode - Default)

- **Canonical Matching:**
  1. Identify canonical albums (MB ID > ID3 tags)
  2. Fingerprint match canonical albums together
  3. Match untagged albums against canonical groups
  4. Untagged albums inherit canonical names

- **Match Confidence:**
  - MusicBrainz ID: 100%
  - ID3 Album/Artist Tags: 90-95%
  - Acoustic Fingerprint: 80-90%

- **Album Similarity:** Average track-by-track fingerprint similarity

#### Perceptual Matching (Track Mode)

- Raw Chromaprint fingerprints (948 32-bit integers)
- Hamming distance for bit-level comparison
- Default similarity threshold: 98.0%
- O(n²) with Union-Find grouping
- Detects duplicates across all bitrates/formats

#### Quality Scoring

- **Lossless:** 10000 + (bit_depth × 100) + (sample_rate / 1000)
- **Lossy:** bitrate / 1000 (in kbps)

#### Caching

- **Default Backend:** SQLite (thread-safe, WAL mode)
- **Location:** `~/.config/duperscooper/hashes.db`
- **Track Cache:** SHA256 file hash → raw fingerprint
- **Album Cache:** Directory path → album metadata
- **Auto-migration:** JSON cache automatically migrated to SQLite

## GUI Development (In Progress)

**Goal:** Create a PySide6/Qt GUI for duperscooper with full integration to CLI backend.

**Status:** Foundation and results viewer complete, settings system implemented

### Completed GUI Features ✅

#### Phase 1: Foundation (PR #12) ✅ **COMPLETE**

**Implemented:**
- Clean directory structure in `src/duperscooper_gui/`
- Main window with tabbed interface (Scan/Results/Staging)
- Qt Designer `.ui` files for visual editing
- Backend interface via subprocess wrapper
- Scan configuration UI (paths, mode, algorithm, threshold, workers)
- Progress tracking infrastructure
- PySide6 dependencies and installation

**Usage:**
```bash
# Install GUI dependencies
pip install -e ".[gui]"

# Launch GUI
duperscooper-gui

# Edit UI in Qt Designer
pyside6-designer src/duperscooper_gui/ui/main_window.ui
```

#### Phase 2: Results Viewer (PR #13, PR #16) ✅ **COMPLETE**

**Implemented:**
- Complete data model for scan results (track and album modes)
- Tree view with 8 columns (Select, Path, Album, Artist, Size, Quality, Similarity, Action)
- Checkboxes for duplicate groups with pre-selection
- Track-level metadata display (album/artist from file tags)
- Quality information display with color coding
- Selection controls (Select All/None/Recommended)
- Deletion preview dialog
- Real-time selection statistics
- Visual highlighting of best quality items
- Platform-specific settings system
- Customizable colors via TOML config

**Features:**
- Smart pre-selection from `recommended_action`
- Best quality items highlighted in bold green
- Color-coded similarity: Dark green (≥99%), Green (≥97%), Orange (≥95%), Red (<95%)
- Icons: 🔊 Audio files, 📁 Folders, 🔍 Search, 💿 Albums
- Comprehensive tooltips with full metadata
- Selection statistics with potential savings
- Two-line summary layout

**Current Workflow:**
1. Run scan or open JSON results file
2. Results automatically loaded into tree view
3. Duplicates pre-selected based on CLI recommendations
4. User adjusts selection as needed
5. Preview deletion shows what will be deleted
6. Delete Selected stages items (backend integration TODO)

### Remaining GUI Features

#### Phase 3: Backend Deletion Integration

**Tasks:**
- Implement actual deletion via backend_interface
- Stage files/albums using CLI staging system
- Show staging success/failure messages
- Update results viewer after deletion
- Handle edge cases and errors

#### Phase 4: Staging Management Interface

**Tasks:**
- List staged batches in Staging tab
- Show batch metadata (date, item count, size)
- Restore interface (batch selection, custom location)
- Empty deleted with retention policies
- Refresh after operations

#### Phase 5: Settings Dialog

**Tasks:**
- Settings/preferences panel accessible through menus (OS-specific)
- Edit colors, scan defaults, UI preferences
- Apply settings to new scans
- Save/load custom settings
- Reset to defaults option

#### Phase 6: Polish & Enhancements

**Tasks:**
- Drag-and-drop for adding scan paths
- Dark mode support
- Save results to JSON
- Export to CSV
- Keyboard shortcuts
- Progress animation improvements
- Window size/position persistence

### GUI Feature Wishlist (Future)

**Completed:**
1. ✅ Fixed unreadable group headers (white on light grey)
2. ✅ Removed " (avg)" from quality data, added to column header
3. ✅ Removed "results viewer coming soon" placeholder
4. ✅ Added Album and Artist columns with metadata

**High Priority:**
5. Settings/preferences/options panel (OS-aware menu placement)
6. Cross-platform support (Linux, macOS, Windows)
7. Track deleted files in current session for easy restoration
8. Recall deletions from previous sessions (manifest tracking)

**Medium Priority:**
9. Open log output in scrollable window or external program
10. Save log output to file
11. Show/hide columns (protect critical columns, suggest additional like MusicBrainz tags)
12. Resize and reorder columns
13. Save table state (columns, order, widths) with reset to defaults
14. Speaker icon should match row text color (currently black on dark grey)
15. Remember window size and position

**Low Priority:**
16. Right-click properties view (location, size, SHA, fingerprint, metadata)
17. Click speaker icon to play/pause audio
18. "Deselect Lossless" button in results viewer

## Pre-GUI Feature Implementation: COMPLETE ✅

**Goal:** Implement essential deletion infrastructure before GUI development.

**Status:** All 7 critical features complete - **PROJECT IS GUI-READY!**

### Feature 1: Staging Folder Deletion System ✅ **COMPLETE**

**PR #9 Merged**

- UUID-based staging in `.deletedByDuperscooper/<uuid>/` directories
- Manifest files with SHA256, fingerprints, restoration tracking
- Track-level restoration tracking
- Custom restoration location via `--restore-to`
- Batch archival to `.restored/`
- CLI: `--stage-album`, `--list-deleted`, `--restore`, `--restore-interactive`, `--empty-deleted`

### Feature 2: JSON Ingestion / Apply Rules Mode ✅ **COMPLETE**

**PR #10 Merged**

- `src/duperscooper/rules.py` (RuleEngine, Rule, RuleCondition)
- `src/duperscooper/apply.py` (ScanResultLoader, ApplyEngine)
- Built-in strategies: `eliminate-duplicates`, `keep-lossless`, `keep-format`, `custom`
- CLI: `--apply-rules FILE --strategy STRATEGY [--execute]`

### Features 3-6: Safety & Parity ✅ **COMPLETE**

**PR #11 Merged**

- **Dry-Run Mode:** Default for `--apply-rules`, requires `--execute`
- **Non-Interactive Mode:** `--yes` / `-y` flag for automation
- **recommended_action in JSON:** Pre-selection support for GUI
- **Interactive Album Deletion:** `--delete-duplicate-albums` fully functional

### Feature 7: List/Restore/Empty Commands ✅ **COMPLETE**

**Implemented in PR #9**

- `--list-deleted`, `--restore`, `--restore-interactive`, `--restore-to`
- `--empty-deleted`, `--keep-last N`, `--older-than DAYS`

## Current Feature Set

### Album Mode (Default)

```bash
# Default behavior (album mode)
duperscooper ~/Music

# Explicit album mode
duperscooper ~/Music --album-mode

# Switch to track mode
duperscooper ~/Music --track-mode

# MusicBrainz-only matching
duperscooper ~/Music --album-match-strategy musicbrainz

# Fingerprint-only matching
duperscooper ~/Music --album-match-strategy fingerprint

# Output formats
duperscooper ~/Music --output json > albums.json
duperscooper ~/Music --output csv > albums.csv

# Interactive deletion
duperscooper ~/Music --delete-duplicate-albums

# Non-interactive deletion
duperscooper ~/Music --delete-duplicate-albums --yes

# Partial album detection
duperscooper ~/Music --allow-partial-albums --min-album-overlap 70
```

### Track Mode

```bash
# Track mode (individual files)
duperscooper ~/Music --track-mode

# Exact byte matching (faster)
duperscooper ~/Music --track-mode --algorithm exact

# Adjust similarity threshold
duperscooper ~/Music --track-mode --similarity-threshold 95.0

# Interactive deletion
duperscooper ~/Music --track-mode --delete-duplicates

# Non-interactive deletion
duperscooper ~/Music --track-mode --delete-duplicates --yes
```

### Two-Phase Workflow: Apply Rules

```bash
# Step 1: Scan and save results
duperscooper ~/Music --output json > scan.json

# Step 2: Preview deletion plan (dry-run)
duperscooper --apply-rules scan.json --strategy eliminate-duplicates

# Step 3: Execute deletions
duperscooper --apply-rules scan.json --strategy eliminate-duplicates --execute

# Alternative strategies
duperscooper --apply-rules scan.json --strategy keep-lossless --execute
duperscooper --apply-rules scan.json --strategy keep-format --format FLAC --execute
duperscooper --apply-rules scan.json --strategy custom --config rules.yaml --execute
```

### Staging Management

```bash
# List all staged deletions
duperscooper --list-deleted

# Restore a specific batch
duperscooper --restore <batch-uuid>

# Restore to different location
duperscooper --restore <batch-uuid> --restore-to /new/location

# Interactive restoration
duperscooper --restore-interactive <batch-uuid>

# Permanently delete old staged batches
duperscooper --empty-deleted --older-than 30
duperscooper --empty-deleted --keep-last 5
```

### GUI Usage

```bash
# Launch GUI
duperscooper-gui

# Edit UI files
pyside6-designer src/duperscooper_gui/ui/main_window.ui
```

## Test Environment

### Track Mode Tests

- **Test Files:** `test-audio/` directory
  - test.flac (44.1kHz 16bit, 30.9 MB)
  - 14 MP3 variants (CBR: 64-320kbps, VBR: V2-V9)
  - All successfully detected as duplicates

### Album Mode Tests

- **Test Folders:** `test-albums/` directory
  - 21 album folders total
  - 16 baseline albums (AlbumA × 8, AlbumB × 8)
  - 5 test scenario folders (mixed MB IDs, ID3-only, partial albums)
  - All scenarios verified working correctly

## Development Workflow

### Quality Checks (Must Pass Before Commit)

```bash
.venv/bin/black src/ tests/       # Format code
.venv/bin/ruff check src/ tests/  # Lint
.venv/bin/mypy src/               # Type check
.venv/bin/pytest tests/ -v        # Run tests
```

### Git Workflow

- Remote: `origin` = git@github-ohtostado:ohtostado/duperscooper.git
- Main branch: `main`
- Commit style: Conventional commits (feat:, fix:, docs:, etc.)
- Always reference issues: "Fixes #123" or "Implements #456"

### Installation

```bash
# Setup virtual environment
python -m venv .venv
source .venv/bin/activate  # or .venv\Scripts\activate on Windows

# Install dependencies (CLI only)
pip install -r requirements.txt

# Install with GUI support
pip install -e ".[gui]"

# Install in editable mode
pip install -e .

# Run CLI
duperscooper /path/to/music

# Run GUI
duperscooper-gui
```

## Known Working State

### All Tests Passing ✅

- 22 unit tests (6 in `tests/test_finder.py`, 16 in `tests/test_cache.py`)
- All code quality checks passing (Black, Ruff, MyPy)
- Test coverage for core functionality and cache backends

### Verified Features ✅

**Album Mode (Default):**
- Album discovery and metadata extraction
- Track-level metadata display in results
- MusicBrainz ID matching
- ID3 tag matching
- Acoustic fingerprint matching
- Canonical matching (MB ID → ID3 → fingerprint)
- Mixed MB ID detection and warnings
- Match method display and confidence scoring
- All output formats (text, JSON, CSV)

**Track Mode:**
- Perceptual matching across bitrates (64kbps - FLAC)
- Exact matching fallback
- SQLite cache with thread-local connections
- Parallel fingerprinting (8 workers, 2.7x speedup)
- Quality detection and scoring
- Color output
- All output formats

**GUI:**
- Cross-platform support (Linux, macOS, Windows)
- Platform-specific config paths
- Auto-generated user config from template
- Results viewer with 8 columns
- Color-coded similarity indicators
- Track-level metadata display
- Customizable colors via TOML

## Important Development Notes

### Template System Rules

- **NEVER edit** generated files directly
- **Always edit** template files in `templates/` directory
- **Regenerate** docs after template changes

### Code Style Conventions

- **Black:** 88-character line length
- **Type hints:** Required for all function signatures
- **Docstrings:** Use for public functions/classes
- **No wildcard imports:** Never use `from x import *`
- **Error handling:** Always handle exceptions in file/audio operations

### External Tools Required

- `fpcalc` - Chromaprint fingerprinting binary
- `ffprobe` - Audio metadata extraction (part of FFmpeg)

### Git Configuration

- SSH key alias: `github-ohtostado` (configured in ~/.ssh/config)
- Remote origin uses this alias

## User Preferences

- Uses dark terminal background
- Values accessibility and readability
- Prefers industry-standard libraries
- Likes tasteful, not excessive, color usage
- Focuses on practical UX improvements
- Wants transparency in methodology

## How to Resume Development

1. **Clone repository:**
   ```bash
   git clone git@github-ohtostado:ohtostado/duperscooper.git
   cd duperscooper
   ```

2. **Setup environment:**
   ```bash
   python -m venv .venv
   source .venv/bin/activate
   pip install -r requirements.txt
   pip install -e ".[gui]"
   ```

3. **Verify setup:**
   ```bash
   # Test CLI
   .venv/bin/duperscooper test-audio/
   .venv/bin/duperscooper --album-mode test-albums/

   # Test GUI
   .venv/bin/duperscooper-gui
   ```

4. **Check quality tools:**
   ```bash
   .venv/bin/black src/
   .venv/bin/ruff check src/
   .venv/bin/mypy src/
   .venv/bin/pytest tests/ -v
   ```

5. **Review documentation:**
   - Read `CLAUDE.md` (project instructions)
   - Read `~/.claude/CLAUDE.md` (global guidelines)
   - Review recent commits: `git log --oneline -10`
   - Check GUI plans in this file (GUI Feature Wishlist section)

## Contact & Resources

- **GitHub Repository:** <https://github.com/ohtostado/duperscooper>
- **Issues:** <https://github.com/ohtostado/duperscooper/issues>
- **Python Version:** 3.8+ (developed on 3.13)
- **License:** See LICENSE file

---

**Note for Claude:** This state file provides complete context to resume development. Read this file first, then review `CLAUDE.md` for project conventions, then check recent git history.

**Current Status:**
- Branch: main
- All backend features complete and merged
- GUI foundation and results viewer complete
- Settings system implemented with platform-specific config
- Album mode is now default
- Next: Backend deletion integration, staging tab, settings dialog
