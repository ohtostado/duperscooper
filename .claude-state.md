# Claude Development State - duperscooper

**Last Updated:** 2025-09-30
**Current Branch:** main
**Latest Commit:** 807c185 - fix: improve duplicate list display with sorting and tree characters

## Project Overview

**duperscooper** is a Python CLI application that finds duplicate audio files using fuzzy perceptual matching (Chromaprint fingerprints with Hamming distance) across different formats, bitrates, and encodings.

## Recent Development Session Summary

### Completed Features (Latest Session)

1. **Quality Detection System** (Commit: 942d2ea)
   - Added ffprobe-based audio metadata extraction
   - Implemented quality scoring (lossless > lossy)
   - Enhanced all output formats (text, JSON, CSV) with quality info
   - Shows [Best] marker and similarity percentages
   - Updated interactive delete mode with quality information

2. **Color Output Enhancement** (Commit: c6ac43b)
   - Added colorama dependency for cross-platform color support
   - Color-coded progress indicators (cyan with green "done")
   - Highlighted [Best] files in bright green
   - Similarity color coding:
     - Green: ≥99% (excellent match)
     - Yellow: 95-99% (good match)
     - Orange/red: <95% (lower quality)
   - Dimmed file sizes, bolded headers
   - Applied to all text output (not JSON/CSV)

3. **Display Improvements** (Commit: 807c185)
   - Sort duplicates by similarity descending (best matches first)
   - Fixed tree drawing: use └─ for last item instead of ├─
   - Applied to both regular output and interactive delete mode

## Current Project State

### Technology Stack
- **Language:** Python 3.8+ (tested on 3.13)
- **Audio Fingerprinting:** Direct `fpcalc` binary calls (Python 3.13 compatible)
- **Metadata Extraction:** `ffprobe` binary
- **Dependencies:**
  - `tqdm>=4.66.0` - Progress bars
  - `colorama>=0.4.6` - Cross-platform terminal colors
- **Dev Dependencies:**
  - `black==24.8.0` - Code formatting
  - `ruff==0.6.3` - Linting
  - `mypy==1.11.2` - Type checking
  - `pytest==8.3.2` - Testing
  - `pytest-cov==5.0.0` - Coverage

### Code Structure
```
src/duperscooper/
├── __init__.py       # Package metadata, version
├── __main__.py       # CLI interface, output formatting, colorama integration
├── hasher.py         # AudioHasher: perceptual & exact hashing, metadata extraction
└── finder.py         # DuplicateFinder: search logic
                      # DuplicateManager: file operations, quality detection
```

### Key Algorithms

#### Perceptual Matching (Default)
- Uses raw Chromaprint fingerprints (list of 948 32-bit integers)
- Hamming distance for bit-level comparison
- Default similarity threshold: 98.0%
- O(n²) with Union-Find grouping (suitable for ~10k files)
- Detects duplicates across all bitrates and formats

#### Quality Scoring
- **Lossless:** 10000 + (bit_depth × 100) + (sample_rate / 1000)
- **Lossy:** bitrate / 1000 (in kbps)

#### Caching
- Location: `~/.config/duperscooper/hashes.json`
- Key: SHA256 file hash → raw fingerprint (comma-separated integers)
- Automatically invalidates when files change

### Test Environment
- **Test Files:** `test-audio/` directory
  - test.flac (44.1kHz 16bit, 30.9 MB)
  - 14 MP3 variants (CBR: 64-320kbps, VBR: V2-V9)
  - All successfully detected as duplicates

## Development Workflow

### Quality Checks (Must Pass Before Commit)
```bash
.venv/bin/black src/           # Format code
.venv/bin/ruff check src/      # Lint
.venv/bin/mypy src/            # Type check
.venv/bin/pytest tests/ -v     # Run tests
```

### Git Workflow
- Remote: `origin` = git@github-ohtostado:ohtostado/duperscooper.git
- Main branch: `main`
- Commit style: Conventional commits (feat:, fix:, docs:, etc.)
- Always reference issues: "Fixes #123" or "Implements #456"

### Installation
```bash
# Setup virtual environment
python -m venv .venv
source .venv/bin/activate  # or .venv\Scripts\activate on Windows

# Install dependencies
pip install -r requirements.txt

# Install in editable mode
pip install -e .

# Run application
duperscooper /path/to/music
```

## Current Feature Set

### CLI Options
```bash
# Basic usage
duperscooper ~/Music

# Exact byte matching (faster, less flexible)
duperscooper ~/Music --algorithm exact

# Adjust similarity threshold
duperscooper ~/Music --similarity-threshold 95.0

# Output formats
duperscooper ~/Music --output json
duperscooper ~/Music --output csv

# Interactive deletion
duperscooper ~/Music --delete-duplicates

# Cache management
duperscooper --clear-cache
duperscooper ~/Music --no-cache
duperscooper ~/Music --update-cache

# Other options
duperscooper ~/Music --min-size 0           # Include small files
duperscooper ~/Music --no-progress          # Disable progress output
```

### Output Formats

#### Text (Default)
```
Found 1 group(s) of duplicate files:

Group 1 (Hash: group_14...)
  [Best] /path/test.flac (30.9 MB) - FLAC 44.1kHz 16bit
    ├─ /path/test-c320.mp3 (13.4 MB) - MP3 CBR 320kbps [99.9% match]
    ├─ /path/test-c192.mp3 (8.0 MB) - MP3 CBR 192kbps [99.8% match]
    └─ /path/test-c064.mp3 (2.7 MB) - MP3 CBR 64kbps [98.9% match]
```

#### JSON
Includes: `audio_info`, `quality_score`, `similarity_to_best`, `is_best` fields

#### CSV
Columns: `group_id,hash,file_path,file_size,file_size_bytes,audio_info,quality_score,similarity_to_best,is_best`

## Known Working State

### All Tests Passing ✅
- 6 unit tests in `tests/test_finder.py`
- All code quality checks passing
- Test coverage for core functionality

### Verified Features ✅
- Perceptual matching across bitrates (64kbps - FLAC)
- Exact matching fallback
- Cache persistence and invalidation
- Quality detection and scoring
- Color output (tested on Linux terminal)
- Sorting by similarity
- Interactive deletion
- All output formats

## Next Steps / Future Enhancements

### Potential Features (from CLAUDE.md)
- Parallel hashing with multiprocessing
- Preview audio before deletion
- Dry-run mode for `--delete-duplicates`
- GUI interface
- More exotic audio format support (AIFF, APE, etc.)
- Optional fuzzy duration matching (±1 second tolerance)

### Code Improvements
- More comprehensive integration tests
- Benchmark Chromaprint performance on large libraries
- Performance optimization for libraries >10k files

## Important Development Notes

### Template System Rules (from ~/.claude/CLAUDE.md)
- **NEVER edit** generated files directly (README.adoc, CONTRIBUTING.adoc, etc.)
- **Always edit** template files in `templates/` directory instead
- **Regenerate** docs after template changes

### Code Style Conventions
- **Black:** 88-character line length
- **Type hints:** Required for all function signatures
- **Docstrings:** Use for public functions/classes; focus on complex logic
- **No wildcard imports:** Never use `from x import *`
- **Error handling:** Always handle exceptions in file/audio operations

### External Tools Required
- `fpcalc` - Chromaprint fingerprinting binary
- `ffprobe` - Audio metadata extraction (part of FFmpeg)

### Git Configuration
- SSH key alias: `github-ohtostado` (configured in ~/.ssh/config)
- Remote origin uses this alias

## Troubleshooting

### Common Issues

**Import errors:**
```bash
source .venv/bin/activate
pip install -r requirements.txt
```

**Chromaprint errors:**
```bash
# Ubuntu/Debian
sudo apt install libchromaprint-tools

# macOS
brew install chromaprint
```

**FFprobe errors:**
```bash
# Ubuntu/Debian
sudo apt install ffmpeg

# macOS
brew install ffmpeg
```

## Session Context

### What Was Discussed
1. User requested quality detection feature to identify best quality file in duplicate groups
2. Requested enhanced output showing quality info, encoding details, similarity percentages
3. Requested color output for better UX (dark terminal background consideration)
4. Requested sorting by similarity (best matches first) and proper tree characters (└─ for last item)

### User Preferences
- Uses dark terminal background
- Values accessibility and readability
- Prefers industry-standard libraries over custom implementations (e.g., colorama)
- Likes tasteful, not excessive, color usage
- Focuses on practical UX improvements

### Development Philosophy
- Quality over speed (all checks must pass)
- Follow established patterns in codebase
- Document changes thoroughly
- Test with real audio files
- Conventional commits with issue references

## How to Resume Development

1. **Clone repository:**
   ```bash
   git clone git@github-ohtostado:ohtostado/duperscooper.git
   cd duperscooper
   ```

2. **Setup environment:**
   ```bash
   python -m venv .venv
   source .venv/bin/activate
   pip install -r requirements.txt
   pip install -e .
   ```

3. **Verify setup:**
   ```bash
   .venv/bin/duperscooper test-audio/
   ```

4. **Check all quality tools work:**
   ```bash
   .venv/bin/black src/
   .venv/bin/ruff check src/
   .venv/bin/mypy src/
   .venv/bin/pytest tests/ -v
   ```

5. **Review documentation:**
   - Read `CLAUDE.md` (project-specific instructions)
   - Read `~/.claude/CLAUDE.md` (global development guidelines)
   - Review recent commits: `git log --oneline -10`

## Files Modified in Recent Sessions

### Session 1: Quality Detection
- `src/duperscooper/hasher.py` - Added metadata extraction, quality scoring
- `src/duperscooper/finder.py` - Modified grouping to preserve fingerprints, added quality detection
- `src/duperscooper/__main__.py` - Updated all output formats
- `CLAUDE.md` - Documented quality detection system
- `pyproject.toml` - Dependencies remain same

### Session 2: Color Output
- `pyproject.toml` - Added colorama>=0.4.6
- `requirements.txt` - Added colorama==0.4.6
- `src/duperscooper/__main__.py` - Integrated colorama for text output
- `src/duperscooper/finder.py` - Added colors to progress indicators and interactive delete

### Session 3: Display Improvements
- `src/duperscooper/__main__.py` - Sort by similarity, fix tree characters
- `src/duperscooper/finder.py` - Apply same improvements to interactive delete

## Contact & Resources

- **GitHub Repository:** https://github.com/ohtostado/duperscooper
- **Issues:** https://github.com/ohtostado/duperscooper/issues
- **Python Version:** 3.8+ (developed on 3.13)
- **License:** See LICENSE file

---

**Note for Claude:** This state file provides complete context to resume development. Read this file first, then review `CLAUDE.md` for project conventions, then check recent git history. The codebase is in a stable, fully tested state with all quality checks passing.
