# Claude Development State - duperscooper

**Last Updated:** 2025-10-01
**Current Branch:** feature/album-mode
**Latest Commit:** f592888 - feat(album): display match method for each album

## Project Overview

**duperscooper** is a Python CLI application that finds duplicate audio files using fuzzy perceptual matching (Chromaprint fingerprints with Hamming distance) across different formats, bitrates, and encodings. Now includes album-level duplicate detection.

## Recent Development Session Summary

### Currently In Progress: Album Mode Implementation ðŸš§

**Status:** Phases 1-3 Complete, Testing & Phase 4 Pending

**Branch:** feature/album-mode

### Phase 1: Album Detection & Metadata Extraction (COMPLETED - Commit: 5e54aa9)

**Objective:** Detect albums (directories) and extract comprehensive metadata.

**Completed Work:**

1. **Album Data Structure**
   - Created `Album` dataclass in `src/duperscooper/album.py`
   - Fields: path, tracks, track_count, musicbrainz_albumid, album_name, artist_name, total_size, avg_quality_score, fingerprints, has_mixed_mb_ids, quality_info

2. **Album Scanner**
   - Implemented `AlbumScanner` class for album discovery
   - Non-recursive directory scan (one album = one directory)
   - MusicBrainz Album ID extraction via ffprobe
   - Album/artist tag extraction from audio files
   - Detection of mixed MusicBrainz IDs within album
   - Leverages existing `AudioHasher` for fingerprinting and caching

3. **Integration**
   - Added `--album-mode` CLI flag
   - Added `--album-match-strategy` option (auto, musicbrainz, fingerprint)
   - Separate output formatting for album mode

### Phase 2: Album Matching Strategies (COMPLETED - Commit: 9cd8e77)

**Objective:** Implement multiple strategies for matching duplicate albums.

**Completed Work:**

1. **AlbumDuplicateFinder Class**
   - Three matching strategies: `auto`, `musicbrainz`, `fingerprint`
   - `_match_by_musicbrainz()`: Group by MB ID + track count
   - `_match_by_fingerprints()`: Perceptual similarity using Union-Find
   - `album_similarity()`: Average track-by-track similarity

2. **Auto Strategy Enhancement** (Commits: 0adb5b8, 3e00be4)
   - **Fixed:** Initial bug where tagged/untagged albums didn't group together
   - **Refactored:** Fingerprint all albums first, then merge by MB IDs
   - **Canonical Matching:** Albums with MB IDs or ID3 tags establish canonical version
   - Untagged albums match against canonical versions and inherit their names
   - Prioritizes: MB ID > ID3 tags > fingerprint similarity

3. **Similarity Calculation**
   - Track-by-track fingerprint comparison
   - Average similarity percentage for album grouping
   - Hamming distance between track fingerprints
   - Default threshold: 98% (configurable)

### Phase 3: Matched Album/Artist Identification (COMPLETED - Commits: f4fd46f, ac2b4b7, f592888)

**Objective:** Display matched album/artist names and confidence scores.

**Completed Work:**

1. **Matched Album Info** (Commit: f4fd46f)
   - `get_matched_album_info()`: Determine canonical album/artist for group
   - Prioritizes albums with MB IDs or complete metadata
   - Falls back to most common names if no canonical album

2. **Confidence Scoring**
   - 100%: All albums have matching MusicBrainz Album ID
   - 90-95%: Album/artist metadata matches + high fingerprint similarity
   - 80-90%: Fingerprint similarity only (no metadata match)
   - Calculation factors:
     - Base: 80%
     - +5% if album name matches
     - +5% if artist name matches
     - +0-10% based on avg fingerprint similarity (98-100% range)

3. **Album Cache in SQLite** (Commit: ac2b4b7)
   - Added `album_cache` and `album_tracks` tables
   - Directory mtime-based invalidation
   - Stores: path, metadata, quality info, track list
   - Thread-safe with WAL mode (ready for Phase 5)
   - Schema implemented, integration pending

4. **Match Method Display** (Commit: f592888)
   - Added `match_method` field to `Album` dataclass
   - Shows how album was matched in all output formats:
     - "MusicBrainz Album ID"
     - "ID3 Album/Artist Tags"
     - "Acoustic Fingerprint"
   - Applied to text, JSON, and CSV output

5. **Output Enhancements**
   - Text: Shows matched album/artist, best quality marker, confidence percentage with color coding
   - JSON: Includes `matched_album`, `matched_artist`, `confidence`, `match_method` for each album
   - CSV: Columns for matched info, confidence, match method

### Test Infrastructure (COMPLETED - Current Session)

**Test Scenarios Created:**

1. **Baseline (16 albums)**
   - AlbumA (9 tracks): 8 versions (FLAC/MP3, with/without MB IDs, various bitrates)
   - AlbumB (10/11 tracks): 8 versions (FLAC/MP3, with/without MB IDs, various bitrates)

2. **Test Scenario 1: Mixed MusicBrainz IDs**
   - AlbumA-FLAC-MIXED-MB-IDs (tracks 1-2 correct MB ID, tracks 3-9 fake MB ID)
   - Expected: Match by ID3 tags, show warning about mixed MB IDs

3. **Test Scenario 2: ID3 Tags Only**
   - AlbumA-MP3-ID3-ONLY-320 (MB IDs removed via ffmpeg)
   - AlbumB-MP3-ID3-ONLY-320 (MB IDs removed via ffmpeg)
   - Expected: Match by ID3 tags, group with canonical albums

4. **Test Scenario 3: Partial Albums**
   - AlbumA-FLAC-PARTIAL-missing-2-tracks (7 tracks instead of 9)
   - AlbumB-MP3-PARTIAL-missing-3-tracks (7 tracks instead of 10/11)
   - Expected: No duplicate groups (only 1 album each)

5. **Documentation**
   - Created `test-albums/TEST-SCENARIOS.md` with detailed descriptions

**Test Results (Verified âœ…):**

- AlbumA group: 10 albums matched correctly (8 baseline + 1 ID3-only + 1 mixed-MB)
- AlbumB group: 9 albums matched correctly (8 baseline + 1 ID3-only)
- Partial albums: Correctly excluded (need 2+ albums for duplicate group)
- Match methods displayed correctly with appropriate confidence scores
- Mixed MB IDs handled properly with warning

### Previously Completed: Multithreading Implementation âœ…

**Status:** All Phases Complete (Phase 1, 2, 3) - Merged to main

**Branch:** main (merged from feature/multithreading)

**Key Features:**

1. **SQLite Cache Backend** (Commit: 86d7842)
   - Thread-local database connections
   - WAL mode for concurrent access
   - Auto-migration from JSON cache
   - 16 comprehensive unit tests

2. **Parallel Fingerprinting** (Commit: 1b70aa4)
   - ThreadPoolExecutor with configurable workers (default: 8)
   - Real-time ETA estimation
   - 2.7x speedup on test dataset
   - Thread-safe progress tracking

3. **Performance Benchmarks** (Commit: c0fe445)
   - 8 workers: 63% faster than sequential
   - ~10 files/second on production dataset
   - Diminishing returns beyond 8 workers

### Previously Completed: Quality Detection & Display

1. **Quality Detection System** (Commit: 942d2ea)
   - ffprobe-based metadata extraction
   - Quality scoring (lossless > lossy)
   - Enhanced all output formats

2. **Color Output** (Commit: c6ac43b)
   - Colorama integration
   - Color-coded similarity percentages
   - Highlighted [Best] markers

3. **Display Improvements** (Commit: 807c185)
   - Sorting by similarity descending
   - Proper tree drawing (â””â”€ for last item)

## Current Project State

### Technology Stack

- **Language:** Python 3.8+ (tested on 3.13)
- **Audio Fingerprinting:** Direct `fpcalc` binary calls (Python 3.13 compatible)
- **Metadata Extraction:** `ffprobe` binary
- **Dependencies:**
  - `tqdm>=4.66.0` - Progress bars
  - `colorama>=0.4.6` - Cross-platform terminal colors
- **Dev Dependencies:**
  - `black==24.8.0` - Code formatting
  - `ruff==0.6.3` - Linting
  - `mypy==1.11.2` - Type checking
  - `pytest==8.3.2` - Testing
  - `pytest-cov==5.0.0` - Coverage

### Code Structure

```text
src/duperscooper/
â”œâ”€â”€ __init__.py       # Package metadata, version
â”œâ”€â”€ __main__.py       # CLI interface, output formatting, colorama integration
â”œâ”€â”€ cache.py          # CacheBackend interface, SQLite/JSON implementations
â”œâ”€â”€ hasher.py         # AudioHasher: perceptual & exact hashing, metadata
â”œâ”€â”€ finder.py         # DuplicateFinder: search logic, parallelization
â”‚                     # DuplicateManager: file operations
â””â”€â”€ album.py          # Album: dataclass for album metadata
                      # AlbumScanner: album discovery and metadata extraction
                      # AlbumDuplicateFinder: album duplicate detection
```

### Key Algorithms

#### Album Matching (Album Mode)

- **Canonical Matching:**
  1. Identify canonical albums (MB ID > ID3 tags)
  2. Fingerprint match canonical albums together
  3. Match untagged albums against canonical groups
  4. Untagged albums inherit canonical names

- **Match Confidence:**
  - MusicBrainz ID: 100%
  - ID3 Album/Artist Tags: 90-95%
  - Acoustic Fingerprint: 80-90%

- **Album Similarity:** Average track-by-track fingerprint similarity

#### Perceptual Matching (Track Mode)

- Raw Chromaprint fingerprints (948 32-bit integers)
- Hamming distance for bit-level comparison
- Default similarity threshold: 98.0%
- O(nÂ²) with Union-Find grouping
- Detects duplicates across all bitrates/formats

#### Quality Scoring

- **Lossless:** 10000 + (bit_depth Ã— 100) + (sample_rate / 1000)
- **Lossy:** bitrate / 1000 (in kbps)

#### Caching

- **Default Backend:** SQLite (thread-safe, WAL mode)
- **Location:** `~/.config/duperscooper/hashes.db`
- **Track Cache:** SHA256 file hash â†’ raw fingerprint
- **Album Cache:** Directory path â†’ album metadata (schema ready, integration pending)
- **Auto-migration:** JSON cache automatically migrated to SQLite

### Test Environment

#### Track Mode Tests

- **Test Files:** `test-audio/` directory
  - test.flac (44.1kHz 16bit, 30.9 MB)
  - 14 MP3 variants (CBR: 64-320kbps, VBR: V2-V9)
  - All successfully detected as duplicates

#### Album Mode Tests

- **Test Folders:** `test-albums/` directory
  - 21 album folders total
  - 16 baseline albums (AlbumA Ã— 8, AlbumB Ã— 8)
  - 5 test scenario folders (mixed MB IDs, ID3-only, partial albums)
  - All scenarios verified working correctly

## Development Workflow

### Quality Checks (Must Pass Before Commit)

```bash
.venv/bin/black src/ tests/       # Format code
.venv/bin/ruff check src/ tests/  # Lint
.venv/bin/mypy src/               # Type check
.venv/bin/pytest tests/ -v        # Run tests
```

### Git Workflow

- Remote: `origin` = git@github-ohtostado:ohtostado/duperscooper.git
- Main branch: `main`
- Feature branch: `feature/album-mode` (current)
- Commit style: Conventional commits (feat:, fix:, docs:, etc.)
- Always reference issues: "Fixes #123" or "Implements #456"

### Installation

```bash
# Setup virtual environment
python -m venv .venv
source .venv/bin/activate  # or .venv\Scripts\activate on Windows

# Install dependencies
pip install -r requirements.txt

# Install in editable mode
pip install -e .

# Run application
duperscooper /path/to/music
```

## Current Feature Set

### Track Mode (Default)

```bash
# Basic usage
duperscooper ~/Music

# Exact byte matching (faster, less flexible)
duperscooper ~/Music --algorithm exact

# Adjust similarity threshold
duperscooper ~/Music --similarity-threshold 95.0

# Output formats
duperscooper ~/Music --output json
duperscooper ~/Music --output csv

# Interactive deletion
duperscooper ~/Music --delete-duplicates

# Cache management
duperscooper --clear-cache
duperscooper ~/Music --no-cache
duperscooper ~/Music --update-cache

# Multithreading
duperscooper ~/Music --workers 16
duperscooper ~/Music --workers 1  # Sequential

# Cache backend selection
duperscooper ~/Music --cache-backend json  # Legacy
```

### Album Mode (New)

```bash
# Find duplicate albums
duperscooper ~/Music --album-mode

# MusicBrainz-only matching
duperscooper ~/Music --album-mode --album-match-strategy musicbrainz

# Fingerprint-only matching
duperscooper ~/Music --album-mode --album-match-strategy fingerprint

# Auto strategy (default): canonical matching
duperscooper ~/Music --album-mode --album-match-strategy auto

# Output formats
duperscooper ~/Music --album-mode --output json
duperscooper ~/Music --album-mode --output csv > albums.csv
```

## Known Working State

### All Tests Passing âœ…

- 22 unit tests (6 in `tests/test_finder.py`, 16 in `tests/test_cache.py`)
- All code quality checks passing (Black, Ruff, MyPy)
- Test coverage for core functionality and cache backends

### Verified Features âœ…

**Track Mode:**
- Perceptual matching across bitrates (64kbps - FLAC)
- Exact matching fallback
- SQLite cache with thread-local connections
- Parallel fingerprinting (8 workers, 2.7x speedup)
- Quality detection and scoring
- Color output
- All output formats

**Album Mode:**
- Album discovery and metadata extraction
- MusicBrainz ID matching
- ID3 tag matching
- Acoustic fingerprint matching
- Canonical matching (MB ID â†’ ID3 â†’ fingerprint)
- Mixed MB ID detection and warnings
- Match method display
- Confidence scoring
- All output formats (text, JSON, CSV)

## Next Steps / Future Phases

### Phase 4: Album Cache Integration (Next - In Progress)

**Objective:** Use SQLite album cache to speed up repeated scans.

**Tasks:**
- Integrate `get_album()` / `set_album()` into `AlbumScanner`
- Directory mtime-based cache invalidation (already in schema)
- Test cache hits/misses with album mode
- Measure performance improvement

### Phase 5: Interactive Album Deletion (Pending)

**Objective:** Allow users to interactively delete duplicate albums.

**Tasks:**
- Implement `AlbumManager` class similar to `DuplicateManager`
- Add `--delete-duplicates` support for album mode
- Show album quality, track count, and metadata for decision making
- Allow preview of album contents before deletion
- Confirm deletion of directories (not just files)

### Phase 6: Partial Album Detection (Future)

**Objective:** Detect albums with missing tracks as potential duplicates.

**Tasks:**
- Allow albums with different track counts to match
- Require minimum overlap (e.g., 70% of tracks match)
- Show which tracks are present/missing in each version
- Handle edge cases (bonus tracks, deluxe editions)

### Phase 7: Fuzzy Tag Matching (Future - from CLAUDE.md)

**Objective:** Match albums with misspelled metadata.

**Tasks:**
- Implement Levenshtein distance or similar algorithm
- Match album/artist names against canonical versions within threshold
- Example: "The Beatles" vs "Beatles" or "Led Zeppelin" vs "Led Zepplin"
- Configurable fuzzy matching sensitivity
- Useful for poorly tagged or user-edited metadata

### Other Potential Features

- Preview audio before deletion
- Dry-run mode for `--delete-duplicates`
- GUI interface
- More exotic audio formats (AIFF, APE, etc.)

### Code Improvements

- More comprehensive integration tests for album mode
- Benchmark album mode on large libraries
- Performance optimization for libraries >10k files
- Test coverage for album-specific features

## Important Development Notes

### Template System Rules (from ~/.claude/CLAUDE.md)

- **NEVER edit** generated files directly (README.adoc, CONTRIBUTING.adoc, etc.)
- **Always edit** template files in `templates/` directory instead
- **Regenerate** docs after template changes

### Code Style Conventions

- **Black:** 88-character line length
- **Type hints:** Required for all function signatures
- **Docstrings:** Use for public functions/classes; focus on complex logic
- **No wildcard imports:** Never use `from x import *`
- **Error handling:** Always handle exceptions in file/audio operations

### External Tools Required

- `fpcalc` - Chromaprint fingerprinting binary
- `ffprobe` - Audio metadata extraction (part of FFmpeg)

### Git Configuration

- SSH key alias: `github-ohtostado` (configured in ~/.ssh/config)
- Remote origin uses this alias

## Troubleshooting

### Common Issues

**Import errors:**

```bash
source .venv/bin/activate
pip install -r requirements.txt
```

**Chromaprint errors:**

```bash
# Ubuntu/Debian
sudo apt install libchromaprint-tools

# macOS
brew install chromaprint
```

**FFprobe errors:**

```bash
# Ubuntu/Debian
sudo apt install ffmpeg

# macOS
brew install ffmpeg
```

## Session Context

### What Was Discussed

**Previous Sessions:**
1. Quality detection feature for identifying best quality files
2. Enhanced output with quality info, encoding details, similarity percentages
3. Color output for better UX (dark terminal background)
4. Sorting by similarity and proper tree characters
5. Multithreading implementation (SQLite cache, parallel fingerprinting)

**Current Session (Album Mode):**
1. Implemented album-level duplicate detection (Phases 1-3)
2. Fixed critical matching bug (tagged/untagged albums not grouping)
3. Implemented canonical matching approach (MB ID â†’ ID3 â†’ fingerprint)
4. Added match method display and confidence scoring
5. Created comprehensive test scenarios in test-albums/
6. Verified all test scenarios working correctly
7. Added fuzzy tag matching to future enhancements

### User Preferences

- Uses dark terminal background
- Values accessibility and readability
- Prefers industry-standard libraries over custom implementations
- Likes tasteful, not excessive, color usage
- Focuses on practical UX improvements
- Wants transparency in matching methodology

### Development Philosophy

- Quality over speed (all checks must pass)
- Follow established patterns in codebase
- Document changes thoroughly
- Test with real audio files
- Conventional commits with issue references

## How to Resume Development

1. **Clone repository:**

   ```bash
   git clone git@github-ohtostado:ohtostado/duperscooper.git
   cd duperscooper
   ```

2. **Setup environment:**

   ```bash
   python -m venv .venv
   source .venv/bin/activate
   pip install -r requirements.txt
   pip install -e .
   ```

3. **Switch to album mode branch:**

   ```bash
   git checkout feature/album-mode
   ```

4. **Verify setup:**

   ```bash
   # Test track mode
   .venv/bin/duperscooper test-audio/

   # Test album mode
   .venv/bin/duperscooper --album-mode test-albums/
   ```

5. **Check all quality tools work:**

   ```bash
   .venv/bin/black src/ tests/
   .venv/bin/ruff check src/ tests/
   .venv/bin/mypy src/
   .venv/bin/pytest tests/ -v
   ```

6. **Review documentation:**
   - Read `CLAUDE.md` (project-specific instructions)
   - Read `~/.claude/CLAUDE.md` (global development guidelines)
   - Review recent commits: `git log --oneline -10`
   - Review test scenarios: `cat test-albums/TEST-SCENARIOS.md`

## Files Modified in Recent Sessions

### Session 1-3: Quality, Color, Display (Merged to main)

- `src/duperscooper/hasher.py` - Metadata extraction, quality scoring
- `src/duperscooper/finder.py` - Quality detection, color output, sorting
- `src/duperscooper/__main__.py` - All output formats enhanced
- `pyproject.toml` - Added colorama dependency
- `requirements.txt` - Added colorama==0.4.6

### Session 4: Multithreading (Merged to main)

- `src/duperscooper/cache.py` - NEW: Cache backend interface
- `src/duperscooper/hasher.py` - Refactored for CacheBackend
- `src/duperscooper/finder.py` - ThreadPoolExecutor, ETA
- `src/duperscooper/__main__.py` - Added --workers, --cache-backend
- `tests/test_cache.py` - NEW: 16 unit tests

### Session 5: Album Mode (Current - feature/album-mode branch)

**Phase 1:**
- `src/duperscooper/album.py` - NEW: Album dataclass, AlbumScanner, AlbumDuplicateFinder
- `src/duperscooper/__main__.py` - Added --album-mode, --album-match-strategy

**Phase 2:**
- `src/duperscooper/album.py` - Matching strategies, similarity calculation

**Phase 3:**
- `src/duperscooper/album.py` - Canonical matching, confidence scoring, match_method field
- `src/duperscooper/cache.py` - Album cache schema (get_album, set_album methods)
- `src/duperscooper/__main__.py` - Enhanced album output formats
- `CLAUDE.md` - Added album mode documentation and fuzzy matching future phase

**Test Infrastructure:**
- `test-albums/` - 21 test folders created
- `test-albums/TEST-SCENARIOS.md` - NEW: Test documentation

## Contact & Resources

- **GitHub Repository:** <https://github.com/ohtostado/duperscooper>
- **Issues:** <https://github.com/ohtostado/duperscooper/issues>
- **Python Version:** 3.8+ (developed on 3.13)
- **License:** See LICENSE file

---

**Note for Claude:** This state file provides complete context to resume development. Read this file first, then review `CLAUDE.md` for project conventions, then check recent git history. The album mode feature is currently on `feature/album-mode` branch with Phases 1-3 complete and all test scenarios verified.
